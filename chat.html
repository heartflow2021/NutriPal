<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>營養好朋友 - 對話推薦</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- iOS 狀態欄 -->
    <div class="status-bar">
        <div class="status-bar-time">9:43</div>
        <div class="status-bar-icons">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-full"></i>
        </div>
    </div>

    <!-- 頂部導航 -->
    <div class="nav-header">
        <a href="home.html" style="color: var(--text-primary); margin-right: 12px;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div style="flex: 1; text-align: center; font-weight: 600;">健康需求整理</div>
        <div style="width: 24px;"></div> <!-- 為了保持兩邊對稱 -->
    </div>

    <!-- 進度條 -->
    <div class="progress-container">
        <div class="d-flex justify-content-between" style="font-size: 12px; margin-bottom: 4px;">
            <span>開始</span>
            <span>步驟 2/5</span>
        </div>
        <div class="progress-bar">
            <div class="progress-bar-fill" style="width: 40%;"></div>
        </div>
    </div>

    <!-- 主要內容區 -->
    <div class="app-content" style="background-color: var(--background); padding: 16px;">
        <!-- 對話流程 -->
        <div class="chat-message">
            <div class="avatar" style="background-color: var(--primary);">
                <i class="fas fa-archive"></i>
            </div>
            <div class="chat-bubble">
                <p style="margin: 0 0 8px; font-weight: 600;">小帕 Pal</p>
                <p style="margin: 0;">Hi！我是你的資料整理小幫手小帕！想了解你的需求，幫你找到適合的保健品選項～</p>
            </div>
        </div>

        <div class="chat-message">
            <div class="avatar" style="background-color: var(--primary);">
                <i class="fas fa-archive"></i>
            </div>
            <div class="chat-bubble">
                <p style="margin: 0;">首先，請告訴我你目前最想改善的健康狀況是什麼呢？我來幫你找找大家常選的補品組合～</p>
            </div>
        </div>

        <!-- 選擇按鈕 -->
        <div style="margin-bottom: 24px;">
            <button class="option-button" data-type="health-need" data-value="改善睡眠品質">
                <div class="d-flex align-items-center">
                    <i class="fas fa-moon" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">改善睡眠品質</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">入睡困難、易醒、睡眠淺</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="增強免疫力">
                <div class="d-flex align-items-center">
                    <i class="fas fa-shield-virus" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">增強免疫力</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">容易感冒、抵抗力弱</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="提升腦力與專注">
                <div class="d-flex align-items-center">
                    <i class="fas fa-brain" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">提升腦力與專注</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">注意力不集中、記憶力減退</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="心臟健康">
                <div class="d-flex align-items-center">
                    <i class="fas fa-heartbeat" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">心臟健康</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">血壓、膽固醇控制</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="骨骼與關節健康">
                <div class="d-flex align-items-center">
                    <i class="fas fa-bone" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">骨骼與關節健康</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">關節不適、骨質疏鬆預防</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="視力保健">
                <div class="d-flex align-items-center">
                    <i class="fas fa-eye" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">視力保健</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">用眼疲勞、乾澀、視力保養</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="肝臟保健">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tint" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">肝臟保健</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">解酒、代謝、排毒</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="女性保健">
                <div class="d-flex align-items-center">
                    <i class="fas fa-venus" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">女性保健</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">經期調理、更年期、孕期營養</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="消化系統保健">
                <div class="d-flex align-items-center">
                    <i class="fas fa-apple-alt" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">消化系統保健</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">腸胃健康、消化不良</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="體重管理">
                <div class="d-flex align-items-center">
                    <i class="fas fa-weight" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">體重管理</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">新陳代謝、飽足感、控制食慾</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="其他">
                <div class="d-flex align-items-center">
                    <i class="fas fa-plus" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">其他健康需求</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">輸入您的特定需求</p>
                    </div>
                </div>
            </button>
        </div>

        <div id="health-need-response" style="display: none;">
            <div class="chat-message right">
                <div class="chat-bubble user">
                    <p style="margin: 0;">我選擇<span class="selected-health-need"></span></p>
                </div>
            </div>

            <div class="chat-message">
                <div class="avatar" style="background-color: var(--primary);">
                    <i class="fas fa-archive"></i>
                </div>
                <div class="chat-bubble">
                    <p style="margin: 0;">了解！<span class="health-need-feedback"></span>接下來，請告訴我你目前的生活型態，這樣我能整理更多適合你情況的熱門選項喔～</p>
                </div>
            </div>
        </div>

        <!-- 生活型態選項 -->
        <div id="lifestyle-options" style="margin-bottom: 24px; display: none;">
            <button class="option-button" data-type="lifestyle" data-value="長時間工作">
                <div class="d-flex align-items-center">
                    <i class="fas fa-briefcase" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">長時間工作</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">工作壓力大、久坐</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="經常運動">
                <div class="d-flex align-items-center">
                    <i class="fas fa-running" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">經常運動</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">健身、跑步等運動</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="飲食不規律">
                <div class="d-flex align-items-center">
                    <i class="fas fa-hamburger" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">飲食不規律</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">外食多、不定時進食</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="長時間使用電子產品">
                <div class="d-flex align-items-center">
                    <i class="fas fa-laptop" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">長時間使用電子產品</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">電腦、手機、平板</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="經常熬夜">
                <div class="d-flex align-items-center">
                    <i class="fas fa-hourglass-half" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">經常熬夜</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">睡眠不規律、睡眠品質差</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="經常外食">
                <div class="d-flex align-items-center">
                    <i class="fas fa-utensils" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">經常外食</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">外食、外送、便利商店</p>
                    </div>
                </div>
            </button>
        </div>

        <div id="lifestyle-response" style="display: none;">
            <div class="chat-message right">
                <div class="chat-bubble user">
                    <p style="margin: 0;">我的生活型態是<span class="selected-lifestyle"></span></p>
                </div>
            </div>

            <div class="chat-message">
                <div class="avatar" style="background-color: var(--primary);">
                    <i class="fas fa-archive"></i>
                </div>
                <div class="chat-bubble">
                    <p style="margin: 0;">有幫到你真好！最後，有沒有什麼預算考量呢？這樣我能整理出更符合你的選項～</p>
                </div>
            </div>
        </div>

        <!-- 預算選項 -->
        <div id="budget-options" style="margin-bottom: 24px; display: none;">
            <button class="option-button" data-type="budget" data-value="500">
                <div class="d-flex align-items-center">
                    <i class="fas fa-dollar-sign" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">經濟實惠型（500元以下）</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">基本需求，平價選擇</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="budget" data-value="1000">
                <div class="d-flex align-items-center">
                    <i class="fas fa-dollar-sign" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">中等預算（500-1000元）</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">性價比高，品質保證</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="budget" data-value="2000">
                <div class="d-flex align-items-center">
                    <i class="fas fa-dollar-sign" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">高品質型（1000元以上）</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">高檔品牌，專業配方</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="budget" data-value="0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-infinity" style="margin-right: 12px; color: var(--primary);"></i>
                    <div>
                        <p style="margin: 0 0 2px; font-weight: 600;">無預算限制</p>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">優先考慮效果與品質</p>
                    </div>
                </div>
            </button>
        </div>

        <div id="budget-response" style="display: none;">
            <div class="chat-message right">
                <div class="chat-bubble user">
                    <p style="margin: 0;">我選擇<span class="selected-budget"></span></p>
                </div>
            </div>

            <div class="chat-message">
                <div class="avatar" style="background-color: var(--primary);">
                    <i class="fas fa-archive"></i>
                </div>
                <div class="chat-bubble">
                    <p style="margin: 0;">太好了！我已經收集到你的需求了。現在我來為你整理一下熱門推薦的保健品組合吧！</p>
                </div>
            </div>
        </div>

        <!-- 提交按鈕區域 -->
        <div id="submit-container" style="margin-top: 24px; display: none;">
            <button id="submit-selections" class="btn-primary" style="width: 100%;">
                獲取保健品推薦
            </button>
            
            <!-- 加載指示器 -->
            <div id="loading-indicator" style="display: none; text-align: center; margin-top: 20px;">
                <div class="loading-spinner"></div>
                <p>正在整理保健品資訊，請稍候...</p>
            </div>
            
            <!-- 手動跳轉按鈕 -->
            <div id="manual-redirect" style="display: none; text-align: center; margin-top: 20px;">
                <p>自動跳轉失敗，請點擊下方按鈕查看結果</p>
                <button id="manual-redirect-btn" class="btn-secondary" style="display: inline-block; margin-top: 10px;">
                    手動查看結果
                </button>
            </div>
        </div>

        <!-- 添加一個隱藏的表單，用於更可靠的頁面跳轉 -->
        <form id="navigation-form" action="results.html" method="get" style="display: none;">
            <input type="hidden" name="health" value="">
            <input type="hidden" name="lifestyle" value="">
            <input type="hidden" name="budget" value="">
            <input type="hidden" name="time" value="">
        </form>

        <!-- 隱藏的調試工具 -->
        <div id="debug-tools" style="display: none; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px;">
            <h4 style="text-align: center; margin-bottom: 15px;">開發階段調試工具</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button id="debug-show-data" class="btn-secondary" style="font-size: 12px;">
                    顯示sessionStorage數據
                </button>
                <button id="debug-test-redirect" class="btn-secondary" style="font-size: 12px;">
                    測試頁面跳轉
                </button>
                <button id="debug-clear-data" class="btn-secondary" style="font-size: 12px;">
                    清除所有數據
                </button>
            </div>
            <div id="debug-output" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow: auto; display: none;"></div>
        </div>
    </div>

    <!-- 底部導航欄 -->
    <div class="tab-bar">
        <a href="home.html" class="tab-item">
            <i class="fas fa-home"></i>
            <span>首頁</span>
        </a>
        <a href="chat.html" class="tab-item active">
            <i class="fas fa-comment-medical"></i>
            <span>諮詢</span>
        </a>
        <a href="knowledge.html" class="tab-item">
            <i class="fas fa-book-medical"></i>
            <span>知識庫</span>
        </a>
        <a href="#" class="tab-item">
            <i class="fas fa-user"></i>
            <span>我的</span>
        </a>
    </div>

    <!-- 引入腳本 -->
    <script src="js/recommendationEngine.js"></script>
    <!-- 不載入 main.js 以避免語法錯誤問題 -->
    <!-- <script src="js/main.js"></script> -->

    <!-- 確保按鈕點擊事件 -->
    <script>
    // 初始化窗口用戶選擇對象 - 確保它是全局對象
    window.userSelections = {
        healthNeed: '',
        lifestyle: '',
        budget: 0
    };

    document.addEventListener('DOMContentLoaded', function() {
        console.log('頁面加載完成，初始化自定義事件處理');
        
        // 健康需求處理函數
        window.processHealthNeedSelection = function(healthNeed) {
            console.log(`處理健康需求選擇: ${healthNeed}`);
            
            // 直接更新全局對象
            window.userSelections.healthNeed = healthNeed;
            // 同時保存到sessionStorage作為備份
            sessionStorage.setItem('userHealthNeed', healthNeed);
            
            console.log('更新後的選擇:', window.userSelections);
            
            // 更新顯示
            const selectedNeedSpan = document.querySelector('.selected-health-need');
            if (selectedNeedSpan) {
                selectedNeedSpan.textContent = healthNeed;
            }
            
            // 更新反饋文本
            const feedbackSpan = document.querySelector('.health-need-feedback');
            if (feedbackSpan) {
                // 依據不同的健康需求給出不同反饋
                const feedbacks = {
                    '改善睡眠品質': '良好的睡眠對健康很重要呢。',
                    '增強免疫力': '保持良好的免疫系統對健康很重要。',
                    '提升腦力與專注': '腦力和專注力對日常生活和工作都很重要。',
                    '心臟健康': '心臟健康是整體健康的關鍵。',
                    '骨骼與關節健康': '保持骨骼和關節健康能讓活動更輕鬆。',
                    '視力保健': '保護視力在現代數位生活中尤為重要。',
                    '肝臟保健': '肝臟是身體重要的解毒器官。',
                    '女性保健': '女性健康需要特別的照顧和關注。',
                    '消化系統保健': '健康的消化系統是整體健康的基礎。',
                    '體重管理': '健康的體重管理對整體健康很重要。'
                };
                
                const feedbackText = feedbacks[healthNeed] || '了解您的健康需求了。';
                feedbackSpan.textContent = feedbackText;
            }
            
            // 顯示健康需求回應
            const healthNeedResponse = document.getElementById('health-need-response');
            if (healthNeedResponse) {
                healthNeedResponse.style.display = 'block';
                healthNeedResponse.classList.add('fade-in');
            }
            
            // 延遲顯示生活型態選項
            setTimeout(() => {
                const lifestyleOptions = document.getElementById('lifestyle-options');
                if (lifestyleOptions) {
                    lifestyleOptions.style.display = 'block';
                    lifestyleOptions.classList.add('fade-in');
                    
                    // 確保滾動到可見區域
                    try {
                        lifestyleOptions.scrollIntoView({ behavior: 'smooth' });
                    } catch (scrollError) {
                        // 使用備用滾動方法
                        window.scrollBy(0, 200);
                    }
                }
            }, 800);
        };
        
        // 生活型態選擇處理函數
        window.processLifestyleSelection = function(lifestyle) {
            console.log(`處理生活型態選擇: ${lifestyle}`);
            
            // 直接更新全局對象
            window.userSelections.lifestyle = lifestyle;
            // 同時保存到sessionStorage作為備份
            sessionStorage.setItem('userLifestyle', lifestyle);
            
            console.log('更新後的選擇:', window.userSelections);
            
            // 更新顯示
            const selectedLifestyleSpan = document.querySelector('.selected-lifestyle');
            if (selectedLifestyleSpan) {
                selectedLifestyleSpan.textContent = lifestyle;
            }
            
            // 顯示生活型態回應
            const lifestyleResponse = document.getElementById('lifestyle-response');
            if (lifestyleResponse) {
                lifestyleResponse.style.display = 'block';
                lifestyleResponse.classList.add('fade-in');
            }
            
            // 延遲顯示預算選項
            setTimeout(() => {
                const budgetOptions = document.getElementById('budget-options');
                if (budgetOptions) {
                    budgetOptions.style.display = 'block';
                    budgetOptions.classList.add('fade-in');
                    
                    // 確保滾動到可見區域
                    try {
                        budgetOptions.scrollIntoView({ behavior: 'smooth' });
                    } catch (scrollError) {
                        // 使用備用滾動方法
                        window.scrollBy(0, 200);
                    }
                }
            }, 800);
        };
        
        // 預算選擇處理函數
        window.processBudgetSelection = function(budget) {
            console.log(`處理預算選擇: ${budget}`);
            
            const budgetValue = parseInt(budget, 10) || 0;
            
            // 直接更新全局對象
            window.userSelections.budget = budgetValue;
            // 同時保存到sessionStorage作為備份
            sessionStorage.setItem('userBudget', budgetValue);
            
            console.log('更新後的選擇:', window.userSelections);
            
            // 更新顯示
            const selectedBudgetSpan = document.querySelector('.selected-budget');
            if (selectedBudgetSpan) {
                // 依據預算值顯示不同的文本
                let budgetText = '';
                switch (budget) {
                    case '500':
                        budgetText = '經濟實惠型（500元以下）';
                        break;
                    case '1000':
                        budgetText = '中等預算（500-1000元）';
                        break;
                    case '2000':
                        budgetText = '高品質型（1000元以上）';
                        break;
                    case '0':
                    default:
                        budgetText = '無預算限制';
                        break;
                }
                selectedBudgetSpan.textContent = budgetText;
            }
            
            // 顯示預算回應
            const budgetResponse = document.getElementById('budget-response');
            if (budgetResponse) {
                budgetResponse.style.display = 'block';
                budgetResponse.classList.add('fade-in');
            }
            
            // 延遲顯示提交按鈕
            setTimeout(() => {
                const submitContainer = document.getElementById('submit-container');
                if (submitContainer) {
                    submitContainer.style.display = 'block';
                    submitContainer.classList.add('fade-in');
                    
                    // 確保滾動到可見區域
                    try {
                        submitContainer.scrollIntoView({ behavior: 'smooth' });
                    } catch (scrollError) {
                        // 使用備用滾動方法
                        window.scrollBy(0, 200);
                    }
                }
            }, 800);
        };
        
        // 直接綁定健康需求按鈕
        const healthButtons = document.querySelectorAll('button[data-type="health-need"]');
        console.log(`找到 ${healthButtons.length} 個健康需求按鈕`);
        
        healthButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                console.log(`點擊了健康需求按鈕: ${value}`);
                
                // 移除其他按鈕的選中狀態
                healthButtons.forEach(btn => btn.classList.remove('selected'));
                
                // 添加當前按鈕的選中狀態
                this.classList.add('selected');
                
                // 調用自定義處理函數
                window.processHealthNeedSelection(value);
            });
            console.log(`成功綁定健康需求按鈕: ${button.getAttribute('data-value')}`);
        });
        
        // 綁定生活型態按鈕
        const lifestyleButtons = document.querySelectorAll('button[data-type="lifestyle"]');
        console.log(`找到 ${lifestyleButtons.length} 個生活型態按鈕`);
        
        lifestyleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                console.log(`點擊了生活型態按鈕: ${value}`);
                
                // 移除其他按鈕的選中狀態
                lifestyleButtons.forEach(btn => btn.classList.remove('selected'));
                
                // 添加當前按鈕的選中狀態
                this.classList.add('selected');
                
                // 調用自定義處理函數
                window.processLifestyleSelection(value);
            });
        });
        
        // 綁定預算按鈕
        const budgetButtons = document.querySelectorAll('button[data-type="budget"]');
        console.log(`找到 ${budgetButtons.length} 個預算按鈕`);
        
        budgetButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                console.log(`點擊了預算按鈕: ${value}`);
                
                // 移除其他按鈕的選中狀態
                budgetButtons.forEach(btn => btn.classList.remove('selected'));
                
                // 添加當前按鈕的選中狀態
                this.classList.add('selected');
                
                // 調用自定義處理函數
                window.processBudgetSelection(value);
            });
        });
        
        // 綁定提交按鈕
        const submitButton = document.getElementById('submit-selections');
        if (submitButton) {
            console.log('找到提交按鈕');
            submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('點擊了提交按鈕');
                
                // 檢查必要選擇
                if (!window.userSelections.healthNeed) {
                    alert('請選擇您的健康需求');
                    return;
                }
                
                // 提前顯示加載提示
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'block';
                }

                console.log('當前用戶選擇:', JSON.stringify(window.userSelections));
                
                // 創建備用的測試產品數據
                const testProducts = [
                    {
                        id: "test1",
                        name: "褪黑激素3mg",
                        brand: "睡眠專家",
                        description: "促進自然睡眠的褪黑激素補充劑，改善入睡時間和睡眠品質。",
                        price: 350,
                        rating: 4.6,
                        image_url: "https://via.placeholder.com/150",
                        benefits: ["改善睡眠質量", "縮短入睡時間", "調節生理時鐘"],
                        usage: "睡前30分鐘服用1粒",
                        caution: "白天避免服用，可能導致嗜睡",
                        ingredients: "褪黑激素、植物性膠囊",
                        health_needs: ["改善睡眠品質"],
                        lifestyle_match: ["經常熬夜", "長時間工作"]
                    },
                    {
                        id: "test2",
                        name: "複合鎂補充劑",
                        brand: "營養均衡",
                        description: "含多種形式鎂的複合配方，幫助放鬆肌肉，改善睡眠，緩解壓力。",
                        price: 420,
                        rating: 4.5,
                        image_url: "https://via.placeholder.com/150",
                        benefits: ["肌肉放鬆", "改善睡眠", "減輕壓力"],
                        usage: "每日1-2粒，晚餐時服用",
                        caution: "某些形式的鎂可能有輕微腹瀉作用",
                        ingredients: "甘氨酸鎂、檸檬酸鎂、氧化鎂",
                        health_needs: ["改善睡眠品質", "骨骼與關節健康"],
                        lifestyle_match: ["長時間工作", "經常熬夜"]
                    }
                ];

                try {
                    console.log('準備提交選擇，跳轉到結果頁面');
                    
                    // 創建測試產品數據字符串
                    const testProductsJson = JSON.stringify(testProducts);
                    
                    // 儲存完整數據到 sessionStorage
                    sessionStorage.setItem('recommendedProducts', testProductsJson);
                    sessionStorage.setItem('userHealthNeed', window.userSelections.healthNeed);
                    sessionStorage.setItem('userLifestyle', window.userSelections.lifestyle || '');
                    sessionStorage.setItem('userBudget', window.userSelections.budget || 0);
                    
                    console.log('已將數據保存到sessionStorage');
                    console.log('驗證sessionStorage數據:');
                    console.log('- userHealthNeed:', sessionStorage.getItem('userHealthNeed'));
                    console.log('- userLifestyle:', sessionStorage.getItem('userLifestyle'));
                    console.log('- userBudget:', sessionStorage.getItem('userBudget'));
                    console.log('- recommendedProducts長度:', JSON.parse(sessionStorage.getItem('recommendedProducts')).length);
                    
                    // 使用超連結元素進行跳轉
                    console.log('使用新方法進行頁面跳轉');
                    
                    // 創建一個超連結並點擊
                    const link = document.createElement('a');
                    link.href = 'results.html';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    
                    console.log('跳轉連結已創建，即將點擊');
                    
                    // 確保超連結已經添加到DOM中
                    setTimeout(function() {
                        console.log('觸發連結點擊');
                        link.click();
                        
                        // 備用方案：如果點擊無效，直接設置location
                        setTimeout(function() {
                            console.log('檢查是否成功跳轉');
                            if (window.location.href.indexOf('results.html') === -1) {
                                console.log('連結點擊無效，嘗試直接設置location');
                                window.location.href = 'results.html';
                                
                                // 最後備用：如果還是不行，嘗試顯示手動按鈕
                                setTimeout(function() {
                                    if (window.location.href.indexOf('results.html') === -1) {
                                        console.log('所有跳轉方式失敗，顯示手動按鈕');
                                        if (loadingIndicator) {
                                            loadingIndicator.style.display = 'none';
                                        }
                                        const manualRedirect = document.getElementById('manual-redirect');
                                        if (manualRedirect) {
                                            manualRedirect.style.display = 'block';
                                            alert('自動跳轉失敗，請點擊"手動查看結果"按鈕');
                                        }
                                    }
                                }, 2000);
                            }
                        }, 1000);
                    }, 100);
                    
                } catch (err) {
                    console.error('提交處理出錯:', err);
                    alert('發生錯誤，請重試: ' + err.message);
                    
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                    
                    // 顯示手動跳轉按鈕
                    const manualRedirect = document.getElementById('manual-redirect');
                    if (manualRedirect) {
                        manualRedirect.style.display = 'block';
                    }
                }
            });
        }
        
        // 綁定手動跳轉按鈕
        const manualRedirectBtn = document.getElementById('manual-redirect-btn');
        if (manualRedirectBtn) {
            manualRedirectBtn.addEventListener('click', function() {
                console.log('點擊了手動跳轉按鈕');
                
                // 先確保所有數據都儲存到sessionStorage
                sessionStorage.setItem('userHealthNeed', window.userSelections.healthNeed || '改善睡眠品質');
                sessionStorage.setItem('userLifestyle', window.userSelections.lifestyle || '長時間工作');
                sessionStorage.setItem('userBudget', window.userSelections.budget || 0);
                
                // 確保有測試數據
                if (!sessionStorage.getItem('recommendedProducts')) {
                    const testProducts = [
                        {
                            id: "manual1",
                            name: "手動跳轉-測試產品",
                            brand: "測試品牌",
                            description: "這是通過手動跳轉按鈕創建的測試產品數據。",
                            price: 350,
                            rating: 4.5,
                            image_url: "https://via.placeholder.com/150",
                            benefits: ["測試功效1", "測試功效2"],
                            usage: "測試用法說明",
                            caution: "測試注意事項",
                            ingredients: "測試成分",
                            health_needs: ["改善睡眠品質"],
                            lifestyle_match: ["長時間工作"]
                        }
                    ];
                    sessionStorage.setItem('recommendedProducts', JSON.stringify(testProducts));
                }
                
                // 直接使用location.replace進行跳轉，這樣不會添加到歷史記錄中
                try {
                    console.log('手動跳轉 - 嘗試使用location.replace');
                    window.location.replace('results.html');
                } catch (err) {
                    console.error('手動跳轉 - location.replace失敗:', err);
                    
                    // 如果replace失敗，嘗試使用href
                    try {
                        console.log('手動跳轉 - 嘗試使用location.href');
                        window.location.href = 'results.html';
                    } catch (err2) {
                        console.error('手動跳轉 - location.href也失敗:', err2);
                        alert('跳轉失敗，請嘗試直接在瀏覽器地址欄輸入 /results.html');
                    }
                }
            });
        }
    });

    // 在開發模式下顯示調試工具
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        document.getElementById('debug-tools').style.display = 'block';
        
        // 顯示sessionStorage數據
        document.getElementById('debug-show-data').addEventListener('click', function() {
            const output = document.getElementById('debug-output');
            output.style.display = 'block';
            let data = '';
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                let value = sessionStorage.getItem(key);
                
                // 如果是JSON，嘗試格式化顯示
                try {
                    const parsedValue = JSON.parse(value);
                    if (typeof parsedValue === 'object') {
                        value = '(Object with ' + Object.keys(parsedValue).length + ' properties)';
                    }
                } catch (e) {
                    // 不是JSON，保持原樣
                }
                
                data += `${key}: ${value}\n`;
            }
            
            // 顯示window.userSelections
            data += '\nwindow.userSelections:\n';
            data += JSON.stringify(window.userSelections, null, 2);
            
            output.textContent = data;
        });
        
        // 測試頁面跳轉
        document.getElementById('debug-test-redirect').addEventListener('click', function() {
            const output = document.getElementById('debug-output');
            output.style.display = 'block';
            output.textContent = '嘗試跳轉到results.html...\n';
            
            // 依次嘗試不同的跳轉方式
            const methods = [
                '1. location.href',
                '2. location.replace',
                '3. 創建連結並點擊',
                '4. 創建表單並提交',
                '5. window.open'
            ];
            
            let currentMethod = 0;
            
            function tryNextMethod() {
                if (currentMethod >= methods.length) {
                    output.textContent += '\n所有跳轉方式都已嘗試完畢。請檢查網頁和控制台。';
                    return;
                }
                
                output.textContent += `\n嘗試方法: ${methods[currentMethod]}\n`;
                
                switch (currentMethod) {
                    case 0:
                        try {
                            window.location.href = 'results.html';
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            currentMethod++;
                            setTimeout(tryNextMethod, 1000);
                        }
                        break;
                        
                    case 1:
                        try {
                            window.location.replace('results.html');
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            currentMethod++;
                            setTimeout(tryNextMethod, 1000);
                        }
                        break;
                        
                    case 2:
                        try {
                            const link = document.createElement('a');
                            link.href = 'results.html';
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            currentMethod++;
                            setTimeout(tryNextMethod, 1000);
                        }
                        break;
                        
                    case 3:
                        try {
                            const form = document.createElement('form');
                            form.action = 'results.html';
                            form.method = 'get';
                            document.body.appendChild(form);
                            form.submit();
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            currentMethod++;
                            setTimeout(tryNextMethod, 1000);
                        }
                        break;
                        
                    case 4:
                        try {
                            window.open('results.html', '_self');
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            output.textContent += '\n所有方法都嘗試失敗。';
                        }
                        break;
                }
                
                currentMethod++;
            }
            
            tryNextMethod();
        });
        
        // 清除所有數據
        document.getElementById('debug-clear-data').addEventListener('click', function() {
            sessionStorage.clear();
            window.userSelections = {
                healthNeed: '',
                lifestyle: '',
                budget: 0
            };
            
            const output = document.getElementById('debug-output');
            output.style.display = 'block';
            output.textContent = '所有數據已清除';
        });
    }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>營養諮詢 - 與小帕聊聊你的健康需求 | NutriPal</title>
    <meta name="description" content="透過簡單對話了解你的健康需求，NutriPal 小帕會根據你的生活習慣推薦合適的營養補充方案。">
    <meta name="keywords" content="營養諮詢,健康需求,營養補充,保健品推薦,NutriPal,小帕">
    <link rel="icon" type="image/x-icon" href="icon_pal.ico">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- 頂部簡化免責聲明 -->
    <div class="top-disclaimer">
        <i class="fas fa-heart"></i>
        <span class="top-disclaimer-text">小帕僅提供營養資訊與知識整理，不提供任何醫療診斷、治療或預防建議，所有內容僅供參考，健康決策請諮詢專業醫師～</span>
        <button class="top-disclaimer-toggle" onclick="toggleDisclaimer(this)">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>

    <!-- 頂部導航 -->
    <div class="nav-header">
        <a href="index.html" style="color: var(--text-primary); margin-right: 12px;" /* keep-inline */>
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="nav-title">健康知識整理</div>
        <div class="spacer-24"></div> <!-- 為了保持兩邊對稱 -->
    </div>

    <!-- 主要內容區 -->
    <div class="app-content bg-background p-16">
        <!-- 對話流程 -->
        <div class="chat-message chat-message-animated">
            <div class="avatar avatar-transparent">
                <img src="images/mascot/palpal-avatar.png" alt="小帕" class="avatar-image">
            </div>
            <div class="chat-bubble">
                <p class="text-margin-bottom-8" style="font-weight: 600;" /* keep-inline */>小帕 PalPal</p>
                <p class="text-no-margin">哈囉哈囉～我是你的營養知識小幫手小帕！超級開心能幫你整理健康資訊，一起來找找適合你的營養知識吧～</p>
            </div>
        </div>

        <div class="chat-message chat-message-animated">
            <div class="avatar avatar-transparent">
                <img src="images/mascot/palpal-avatar.png" alt="小帕" class="avatar-image">
            </div>
            <div class="chat-bubble">
                <p class="text-no-margin">先告訴我你最近對哪方面的健康知識特別感興趣呢？我會幫你整理相關的營養資訊喔～</p>
            </div>
        </div>

        <!-- 選擇按鈕 -->
        <div class="mb-24">
            <button class="option-button" data-type="health-need" data-value="睡眠相關知識" onclick="showLifestyleOptions('睡眠相關知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-moon icon-with-margin"></i>
                    <div>
                        <p class="text-title">睡眠相關知識</p>
                        <p class="text-subtitle">入睡時間、睡眠週期、睡眠環境</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="免疫系統知識" onclick="showLifestyleOptions('免疫系統知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-shield-virus icon-with-margin"></i>
                    <div>
                        <p class="text-title">免疫系統知識</p>
                        <p class="text-subtitle">免疫系統功能、季節性變化</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="女性健康知識" onclick="showLifestyleOptions('女性健康知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-venus icon-with-margin"></i>
                    <div>
                        <p class="text-title">女性健康知識</p>
                        <p class="text-subtitle">女性生理週期、更年期知識</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="消化系統知識" onclick="showLifestyleOptions('消化系統知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-apple-alt icon-with-margin"></i>
                    <div>
                        <p class="text-title">消化系統知識</p>
                        <p class="text-subtitle">腸胃健康、消化過程</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="體重管理知識" onclick="showLifestyleOptions('體重管理知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-weight icon-with-margin"></i>
                    <div>
                        <p class="text-title">體重管理知識</p>
                        <p class="text-subtitle">代謝知識、營養均衡</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="大腦與認知知識" onclick="showLifestyleOptions('大腦與認知知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-brain icon-with-margin"></i>
                    <div>
                        <p class="text-title">大腦與認知知識</p>
                        <p class="text-subtitle">認知功能、大腦營養素</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="health-need" data-value="心血管系統知識" onclick="showLifestyleOptions('心血管系統知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-heartbeat icon-with-margin"></i>
                    <div>
                        <p class="text-title">心血管系統知識</p>
                        <p class="text-subtitle">心臟功能、血管健康知識</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="骨骼與關節知識" onclick="showLifestyleOptions('骨骼與關節知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-bone icon-with-margin"></i>
                    <div>
                        <p class="text-title">骨骼與關節知識</p>
                        <p class="text-subtitle">關節運動、骨質密度知識</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="視力保健知識" onclick="showLifestyleOptions('視力保健知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-eye icon-with-margin"></i>
                    <div>
                        <p class="text-title">視力保健知識</p>
                        <p class="text-subtitle">用眼習慣、視力保養知識</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="肝臟保健知識" onclick="showLifestyleOptions('肝臟保健知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tint icon-with-margin"></i>
                    <div>
                        <p class="text-title">肝臟保健知識</p>
                        <p class="text-subtitle">肝臟功能、代謝知識</p>
                    </div>
                </div>
            </button>
            
            <button class="option-button" data-type="health-need" data-value="其他" onclick="showLifestyleOptions('其他健康知識')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-plus icon-with-margin"></i>
                    <div>
                        <p class="text-title">其他健康知識</p>
                        <p class="text-subtitle">輸入您想了解的健康主題</p>
                    </div>
                </div>
            </button>
            
            <!-- 底部額外間距，確保按鈕不被導航欄遮擋 -->
            <div class="spacer-height-30"></div>
        </div>

        <div id="health-need-response" class="display-none">
        <div class="chat-message right chat-message-animated">
            <div class="chat-bubble user">
                    <p class="text-no-margin">我想了解<span class="selected-health-need"></span></p>
            </div>
        </div>

        <div class="chat-message chat-message-animated">
                <div class="avatar avatar-transparent">
                    <img src="images/mascot/palpal-avatar.png" alt="小帕" class="avatar-image">
            </div>
            <div class="chat-bubble">
                    <p class="text-no-margin">太棒了！<span class="health-need-feedback"></span>小帕接下來想知道你的生活型態是怎樣的呢？這樣才能幫你找到更適合的健康知識資訊喔～</p>
                </div>
            </div>
        </div>

        <!-- 生活型態選項 -->
        <div id="lifestyle-options" class="mb-24 display-none">
            <button class="option-button" data-type="lifestyle" data-value="長時間工作" onclick="showBudgetOptions('長時間工作')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-briefcase icon-with-margin"></i>
                    <div>
                        <p class="text-title">長時間工作</p>
                        <p class="text-subtitle">工作壓力大、久坐</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="經常運動" onclick="showBudgetOptions('經常運動')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-running icon-with-margin"></i>
                    <div>
                        <p class="text-title">經常運動</p>
                        <p class="text-subtitle">健身、跑步等運動</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="飲食不規律" onclick="showBudgetOptions('飲食不規律')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-hamburger icon-with-margin"></i>
                    <div>
                        <p class="text-title">飲食不規律</p>
                        <p class="text-subtitle">外食多、不定時進食</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="長時間使用電子產品" onclick="showBudgetOptions('長時間使用電子產品')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-laptop icon-with-margin"></i>
                    <div>
                        <p class="text-title">長時間使用電子產品</p>
                        <p class="text-subtitle">電腦、手機、平板</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="經常熬夜" onclick="showBudgetOptions('經常熬夜')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-hourglass-half icon-with-margin"></i>
                    <div>
                        <p class="text-title">經常熬夜</p>
                        <p class="text-subtitle">睡眠不規律、睡眠品質差</p>
                    </div>
                </div>
            </button>

            <button class="option-button" data-type="lifestyle" data-value="經常外食" onclick="showBudgetOptions('經常外食')">
                <div class="d-flex align-items-center">
                    <i class="fas fa-utensils icon-with-margin"></i>
                    <div>
                        <p class="text-title">經常外食</p>
                        <p class="text-subtitle">外食、外送、便利商店</p>
                    </div>
                </div>
            </button>
        </div>

        <div id="lifestyle-response" class="display-none">
            <div class="chat-message right chat-message-animated">
                <div class="chat-bubble user">
                    <p class="text-no-margin">我的生活型態是<span class="selected-lifestyle"></span></p>
                </div>
            </div>

            <div class="chat-message chat-message-animated">
                <div class="avatar avatar-transparent">
                    <img src="images/mascot/palpal-avatar.png" alt="小帕" class="avatar-image">
                </div>
                <div class="chat-bubble">
                    <p class="text-no-margin">謝謝你告訴我這些！最後一個小問題～有沒有預算上的考量呢？小帕會努力找出最符合你需求的參考資訊～</p>
                </div>
            </div>
        </div>

        <!-- 預算選項 -->
        <div id="budget-options" class="mb-60 display-none">
            <a href="results.html" onclick="saveSelectionAndRedirect('500', event)" class="option-button" data-type="budget" data-value="500" style="text-decoration: none; color: inherit;" /* keep-inline */>
                <div class="d-flex align-items-center">
                    <i class="fas fa-dollar-sign icon-with-margin"></i>
                    <div>
                        <p class="text-title">經濟實惠型（500元以下）</p>
                        <p class="text-subtitle">基本需求，平價選擇</p>
                    </div>
                </div>
            </a>

            <a href="results.html" onclick="saveSelectionAndRedirect('1000', event)" class="option-button" data-type="budget" data-value="1000" style="text-decoration: none; color: inherit;" /* keep-inline */>
                <div class="d-flex align-items-center">
                    <i class="fas fa-dollar-sign icon-with-margin"></i>
                    <div>
                        <p class="text-title">中等預算（500-1000元）</p>
                        <p class="text-subtitle">性價比高，品質保證</p>
                    </div>
                </div>
            </a>

            <a href="results.html" onclick="saveSelectionAndRedirect('2000', event)" class="option-button" data-type="budget" data-value="2000" style="text-decoration: none; color: inherit;" /* keep-inline */>
                <div class="d-flex align-items-center">
                    <i class="fas fa-dollar-sign icon-with-margin"></i>
                    <div>
                        <p class="text-title">高品質型（1000元以上）</p>
                        <p class="text-subtitle">高檔品牌，專業配方</p>
                    </div>
                </div>
            </a>

            <a href="results.html" onclick="saveSelectionAndRedirect('0', event)" class="option-button" data-type="budget" data-value="0" style="text-decoration: none; color: inherit;" /* keep-inline */>
                <div class="d-flex align-items-center">
                    <i class="fas fa-infinity icon-with-margin"></i>
                    <div>
                        <p class="text-title">無預算限制</p>
                        <p class="text-subtitle">優先考慮效果與品質</p>
                    </div>
                </div>
            </a>
            
            <!-- 底部額外間距，防止被導航欄遮擋 -->
            <div class="spacer-height-50"></div>
        </div>

        <div id="budget-response" class="display-none mb-40">
            <div class="chat-message right chat-message-animated">
                <div class="chat-bubble user">
                    <p class="text-no-margin">我選擇<span class="selected-budget"></span></p>
                </div>
            </div>

            <div class="chat-message chat-message-animated">
                <div class="avatar avatar-transparent">
                    <img src="images/mascot/palpal-avatar.png" alt="小帕" class="avatar-image">
                </div>
                <div class="chat-bubble">
                    <p class="text-no-margin">收到收到！小帕已經記下你的需求啦～現在就來幫你整理熱門的健康知識資訊，希望能幫到你喔！</p>
                </div>
            </div>
        </div>

        <!-- 提交按鈕區域 - 恢復到對話流程中，但使用更可靠的方式 -->
        <div id="submit-container" class="mt-24 display-none">
            <a href="results.html" id="submit-selections" class="btn-primary btn-full-width" style="padding: 12px; border-radius: 8px;" /* keep-inline */ onclick="saveSelectionsBeforeRedirect(event)">
                獲取保健品推薦
            </a>
            
            <!-- 加載指示器 -->
            <div id="loading-indicator" style="display: none; text-align: center; margin-top: 20px;" /* keep-inline */>
                <div class="loading-spinner"></div>
                <p>正在整理保健品資訊，請稍候...</p>
            </div>
        </div>

        <!-- 添加一個隱藏的表單，用於更可靠的頁面跳轉 -->
        <form id="navigation-form" action="results.html" method="get" class="display-none">
            <input type="hidden" name="health" value="">
            <input type="hidden" name="lifestyle" value="">
            <input type="hidden" name="budget" value="">
            <input type="hidden" name="time" value="">
        </form>

        <!-- 隱藏的調試工具 -->
        <div id="debug-tools" style="display: none; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px;" /* keep-inline debug tool */>
            <h4 style="text-align: center; margin-bottom: 15px;" /* keep-inline debug tool */>開發階段調試工具</h4>
            <div class="flex-center">
                <button id="debug-show-data" class="btn-secondary" style="font-size: 12px;" /* keep-inline debug tool */>
                    顯示sessionStorage數據
                </button>
                <button id="debug-test-redirect" class="btn-secondary" style="font-size: 12px;" /* keep-inline debug tool */>
                    測試頁面跳轉
            </button>
                <button id="debug-clear-data" class="btn-secondary" style="font-size: 12px;" /* keep-inline debug tool */>
                    清除所有數據
            </button>
            </div>
            <div id="debug-output" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow: auto; display: none;" /* keep-inline debug tool */></div>
        </div>
    </div>

    <!-- 底部導航欄 -->
    <div class="tab-bar">
        <a href="index.html" class="tab-item">
            <i class="fas fa-home"></i>
            <span>首頁</span>
        </a>
        <a href="chat.html" class="tab-item active">
            <i class="fas fa-comment-medical"></i>
            <span>諮詢</span>
        </a>
        <a href="knowledge.html" class="tab-item">
            <i class="fas fa-book-medical"></i>
            <span>知識庫</span>
        </a>
    </div>

    <!-- 引入腳本 - 修改順序確保依賴關係正確 -->
    <script src="js/iherb-reward-config.js"></script>
    <script src="js/models/HealthNeedsMapping-fixed.js"></script>
    <!-- 添加修復後的非模組版產品類 -->
    <script src="js/models/Product-fixed.js"></script>
    <!-- 移除不存在的 JS 文件引用 -->
    <script src="js/main.js"></script>

    <!-- 確保按鈕點擊事件 -->
    <script>
    // 初始化窗口用戶選擇對象 - 確保它是全局對象
    window.userSelections = {
        healthNeed: '',
        lifestyle: '',
        budget: 0
    };

    // 直接通過預算按鈕跳轉的函數
    function saveSelectionAndRedirect(budget, event) {
        // 阻止默認行為，我們將在保存數據後手動跳轉
        event.preventDefault();
        
        console.log('點擊了預算按鈕，準備保存數據並跳轉');

        // 更新預算選擇
        window.userSelections.budget = parseInt(budget, 10) || 0;
        
        // 再次確認健康需求和生活型態已被保存
        const selectedHealthButton = document.querySelector('button[data-type="health-need"].selected');
        if (selectedHealthButton) {
            window.userSelections.healthNeed = selectedHealthButton.getAttribute('data-value');
        } else {
            console.warn('無法找到已選擇的健康需求按鈕，將使用 sessionStorage 的值');
            window.userSelections.healthNeed = sessionStorage.getItem('userHealthNeed') || '睡眠相關知識';
        }
        
        const selectedLifestyleButton = document.querySelector('button[data-type="lifestyle"].selected');
        if (selectedLifestyleButton) {
            window.userSelections.lifestyle = selectedLifestyleButton.getAttribute('data-value');
        } else {
            console.warn('無法找到已選擇的生活型態按鈕，將使用 sessionStorage 的值');
            window.userSelections.lifestyle = sessionStorage.getItem('userLifestyle') || '長時間工作';
        }
        
        console.log('用戶最終選擇:', window.userSelections);
        
        // 使用 localStorage，因為它的可靠性更高
        try {
            localStorage.setItem('userHealthNeed', window.userSelections.healthNeed);
            localStorage.setItem('userLifestyle', window.userSelections.lifestyle);
            localStorage.setItem('userBudget', window.userSelections.budget);
            console.log('已將用戶選擇成功儲存到 localStorage');
        } catch (e) {
            console.error('儲存到 localStorage 失敗:', e);
            // 作為備用，再次嘗試 sessionStorage
            sessionStorage.setItem('userHealthNeed', window.userSelections.healthNeed);
            sessionStorage.setItem('userLifestyle', window.userSelections.lifestyle);
            sessionStorage.setItem('userBudget', window.userSelections.budget);
        }
        
        // 顯示預算選擇的用戶回應
        const budgetResponse = document.getElementById('budget-response');
        if (budgetResponse) {
            budgetResponse.style.display = 'block';
            const selectedBudgetSpan = budgetResponse.querySelector('.selected-budget');
            if (selectedBudgetSpan) {
                const budgetButton = document.querySelector(`a[data-value="${budget}"]`);
                selectedBudgetSpan.textContent = budgetButton ? budgetButton.querySelector('p:first-child').textContent : '';
            }
        }
        
        // 延遲跳轉，讓用戶看到預算選擇的回應
        setTimeout(function() {
            // 優先使用 localStorage 的資料來建立 URL，確保資料一致性
            const health = localStorage.getItem('userHealthNeed');
            const lifestyle = localStorage.getItem('userLifestyle');
            const userBudget = localStorage.getItem('userBudget');
            
            const params = new URLSearchParams();
            params.append('health', health);
            params.append('lifestyle', lifestyle);
            params.append('budget', userBudget);
            
            // 跳轉到結果頁面，並帶上可靠的參數
            window.location.href = 'results.html?' + params.toString();
        }, 1500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('頁面加載完成，初始化自定義事件處理');
        
        // 確保提交按鈕初始狀態為隱藏
        const submitContainer = document.getElementById('submit-container');
        if(submitContainer) {
            console.log('確保提交按鈕初始隱藏');
            submitContainer.style.display = 'none';
        }
        
        // 特殊邏輯：確保提交按鈕在任何環境下都可見 - 適用於所有環境
        setTimeout(function() {
            // 檢查是否已經完成所有選擇
            // 如果用戶已經選擇了預算，那麼顯示提交按鈕
            const selectedBudgetButton = document.querySelector('button[data-type="budget"].selected');
            if (selectedBudgetButton) {
                const submitContainer = document.getElementById('submit-container');
                if (submitContainer && window.getComputedStyle(submitContainer).display === 'none') {
                    console.log('檢測到預算已選擇但按鈕未顯示，現在顯示按鈕');
                    submitContainer.style.display = 'block';
                    
                    // 確保滾動到可見區域
                    try {
                        submitContainer.scrollIntoView({ behavior: 'smooth' });
                    } catch (scrollError) {
                        window.scrollBy(0, 200);
                    }
                }
            }
        }, 2000); // 2秒後檢查
        
        // 健康需求處理函數
        window.showLifestyleOptions = function(healthNeed) {
            console.log(`選擇了健康需求: ${healthNeed}`);
            
            // 設置選中狀態
            document.querySelectorAll('button[data-type="health-need"]').forEach(btn => btn.classList.remove('selected'));
            const currentButton = document.querySelector(`button[data-type="health-need"][data-value="${healthNeed}"]`);
            if (currentButton) currentButton.classList.add('selected');
            
            // 保存選擇到 sessionStorage 和 localStorage，增加可靠性
            window.userSelections.healthNeed = healthNeed;
            sessionStorage.setItem('userHealthNeed', healthNeed);
            localStorage.setItem('userHealthNeed', healthNeed);
            
            // 更新顯示
            const selectedNeedSpan = document.querySelector('.selected-health-need');
            if (selectedNeedSpan) selectedNeedSpan.textContent = healthNeed;
            
            document.getElementById('health-need-response').style.display = 'block';
            
            // 立即顯示生活型態選項
            const lifestyleOptions = document.getElementById('lifestyle-options');
            lifestyleOptions.style.display = 'block';
            lifestyleOptions.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };
        
        // 生活型態選擇處理函數
        window.showBudgetOptions = function(lifestyle) {
            console.log(`選擇了生活型態: ${lifestyle}`);
            
            // 設置選中狀態
            document.querySelectorAll('button[data-type="lifestyle"]').forEach(btn => btn.classList.remove('selected'));
            const currentButton = document.querySelector(`button[data-type="lifestyle"][data-value="${lifestyle}"]`);
            if (currentButton) currentButton.classList.add('selected');

            // 保存選擇到 sessionStorage 和 localStorage
            window.userSelections.lifestyle = lifestyle;
            sessionStorage.setItem('userLifestyle', lifestyle);
            localStorage.setItem('userLifestyle', lifestyle);

            // 更新顯示
            const selectedLifestyleSpan = document.querySelector('.selected-lifestyle');
            if (selectedLifestyleSpan) selectedLifestyleSpan.textContent = lifestyle;
            
            document.getElementById('lifestyle-response').style.display = 'block';
            
            // 立即顯示預算選項
            const budgetOptions = document.getElementById('budget-options');
            budgetOptions.style.display = 'block';
            budgetOptions.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };
        
        // 預算選擇處理函數
        window.processBudgetSelection = function(budget) {
            console.log(`處理預算選擇: ${budget}`);
            
            const budgetValue = parseInt(budget, 10) || 0;
            
            // 直接更新全局對象
            window.userSelections.budget = budgetValue;
            // 同時保存到sessionStorage作為備份
            sessionStorage.setItem('userBudget', budgetValue);
            
            console.log('更新後的選擇:', window.userSelections);
            
            // 更新顯示
            const selectedBudgetSpan = document.querySelector('.selected-budget');
            if (selectedBudgetSpan) {
                // 依據預算值顯示不同的文本
                let budgetText = '';
                switch (budget) {
                    case '500':
                        budgetText = '經濟實惠型（500元以下）';
                        break;
                    case '1000':
                        budgetText = '中等預算（500-1000元）';
                        break;
                    case '2000':
                        budgetText = '高品質型（1000元以上）';
                        break;
                    case '0':
                    default:
                        budgetText = '無預算限制';
                        break;
                }
                selectedBudgetSpan.textContent = budgetText;
            }
            
            // 顯示預算回應
            const budgetResponse = document.getElementById('budget-response');
            if (budgetResponse) {
                budgetResponse.style.display = 'block';
                budgetResponse.classList.add('fade-in');
            }
            
            // 延遲顯示提交按鈕 - 使用可靠的顯示方法
            setTimeout(() => {
                const submitContainer = document.getElementById('submit-container');
                if (submitContainer) {
                    console.log('顯示提交按鈕...');
                    submitContainer.style.display = 'block';
                    
                    // 確保滾動到可見區域
                    try {
                        submitContainer.scrollIntoView({ behavior: 'smooth' });
                    } catch (scrollError) {
                        // 使用備用滾動方法
                        window.scrollBy(0, 200);
                    }
                    
                    // 設置一個備用計時器，檢查5秒後按鈕仍然顯示
                    setTimeout(() => {
                        if (submitContainer && window.getComputedStyle(submitContainer).display === 'none') {
                            console.log('檢測到按鈕未顯示，強制顯示');
                            submitContainer.style.display = 'block';
                        }
                    }, 5000);
                } else {
                    console.error('找不到提交按鈕容器!');
                }
            }, 800);
        };
        
        // 直接綁定健康需求按鈕
        const healthButtons = document.querySelectorAll('button[data-type="health-need"]');
        console.log(`找到 ${healthButtons.length} 個健康需求按鈕`);
        
        healthButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                console.log(`點擊了健康需求按鈕: ${value}`);
                
                // 移除其他按鈕的選中狀態
                healthButtons.forEach(btn => btn.classList.remove('selected'));
                
                // 添加當前按鈕的選中狀態
                this.classList.add('selected');
                
                // 調用自定義處理函數
                window.showLifestyleOptions(value);
            });
            console.log(`成功綁定健康需求按鈕: ${button.getAttribute('data-value')}`);
        });
        
        // 綁定生活型態按鈕
        const lifestyleButtons = document.querySelectorAll('button[data-type="lifestyle"]');
        console.log(`找到 ${lifestyleButtons.length} 個生活型態按鈕`);
        
        lifestyleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                console.log(`點擊了生活型態按鈕: ${value}`);
                
                // 移除其他按鈕的選中狀態
                lifestyleButtons.forEach(btn => btn.classList.remove('selected'));
                
                // 添加當前按鈕的選中狀態
                this.classList.add('selected');
                
                // 調用自定義處理函數
                window.showBudgetOptions(value);
            });
        });
        
        // 綁定預算按鈕
        const budgetButtons = document.querySelectorAll('button[data-type="budget"]');
        console.log(`找到 ${budgetButtons.length} 個預算按鈕`);
        
        budgetButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                console.log(`點擊了預算按鈕: ${value}`);
                
                // 移除其他按鈕的選中狀態
                budgetButtons.forEach(btn => btn.classList.remove('selected'));
                
                // 添加當前按鈕的選中狀態
                this.classList.add('selected');
                
                // 調用自定義處理函數
                window.processBudgetSelection(value);
            });
        });
        
        // 綁定提交按鈕
        const submitButton = document.getElementById('submit-selections');
        if (submitButton) {
            console.log('找到提交按鈕');
            submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('點擊了提交按鈕');
                
                // 檢查必要選擇
                if (!window.userSelections.healthNeed) {
                    alert('請選擇您的健康需求');
                    return;
                }
                
                // 提前顯示加載提示
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'block';
                }

                console.log('當前用戶選擇:', JSON.stringify(window.userSelections));
                
                // 創建備用的測試產品數據
                const testProducts = [
                    {
                        id: "test1",
                        name: "褪黑激素3mg",
                        brand: "睡眠專家",
                        description: "促進自然睡眠的褪黑激素補充劑，改善入睡時間和睡眠品質。",
                        price: 350,
                        rating: 4.6,
                        image_url: "https://via.placeholder.com/150",
                        benefits: ["改善睡眠質量", "縮短入睡時間", "調節生理時鐘"],
                        usage: "睡前30分鐘服用1粒",
                        caution: "白天避免服用，可能導致嗜睡",
                        ingredients: "褪黑激素、植物性膠囊",
                        health_needs: ["改善睡眠品質"],
                        lifestyle_match: [window.userSelections.lifestyle]
                    },
                    {
                        id: "test2",
                        name: "複合鎂補充劑",
                        brand: "營養均衡",
                        description: "含多種形式鎂的複合配方，幫助放鬆肌肉，改善睡眠，緩解壓力。",
                        price: 420,
                        rating: 4.5,
                        image_url: "https://via.placeholder.com/150",
                        benefits: ["肌肉放鬆", "改善睡眠", "減輕壓力"],
                        usage: "每日1-2粒，晚餐時服用",
                        caution: "某些形式的鎂可能有輕微腹瀉作用",
                        ingredients: "甘氨酸鎂、檸檬酸鎂、氧化鎂",
                        health_needs: ["改善睡眠品質", "骨骼與關節健康"],
                        lifestyle_match: [window.userSelections.lifestyle]
                    }
                ];

                try {
                    console.log('準備提交選擇，跳轉到結果頁面');
                    
                    // 創建測試產品數據字符串
                    const testProductsJson = JSON.stringify(testProducts);
                    
                    // 儲存完整數據到 sessionStorage
                    sessionStorage.setItem('recommendedProducts', testProductsJson);
                    sessionStorage.setItem('userHealthNeed', window.userSelections.healthNeed);
                    sessionStorage.setItem('userLifestyle', window.userSelections.lifestyle || '');
                    sessionStorage.setItem('userBudget', window.userSelections.budget || 0);
                    
                    console.log('已將數據保存到sessionStorage');
                    console.log('驗證sessionStorage數據:');
                    console.log('- userHealthNeed:', sessionStorage.getItem('userHealthNeed'));
                    console.log('- userLifestyle:', sessionStorage.getItem('userLifestyle'));
                    console.log('- userBudget:', sessionStorage.getItem('userBudget'));
                    console.log('- recommendedProducts長度:', JSON.parse(sessionStorage.getItem('recommendedProducts')).length);
                    
                    // 使用超連結元素進行跳轉
                    console.log('使用新方法進行頁面跳轉');
                    
                    // 創建一個超連結並點擊
                    const link = document.createElement('a');
                    link.href = 'results.html';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    
                    console.log('跳轉連結已創建，即將點擊');
                    
                    // 確保超連結已經添加到DOM中
                    setTimeout(function() {
                        console.log('觸發連結點擊');
                        link.click();
                        
                        // 備用方案：如果點擊無效，直接設置location
                        setTimeout(function() {
                            console.log('檢查是否成功跳轉');
                            if (window.location.href.indexOf('results.html') === -1) {
                                console.log('連結點擊無效，嘗試直接設置location');
                                window.location.href = 'results.html';
                                
                                // 最後備用：如果還是不行，嘗試顯示手動按鈕
                                setTimeout(function() {
                                    if (window.location.href.indexOf('results.html') === -1) {
                                        console.log('所有跳轉方式失敗，顯示手動按鈕');
                                        if (loadingIndicator) {
                                            loadingIndicator.style.display = 'none';
                                        }
                                        const manualRedirect = document.getElementById('manual-redirect');
                                        if (manualRedirect) {
                                            manualRedirect.style.display = 'block';
                                            alert('自動跳轉失敗，請點擊"手動查看結果"按鈕');
                                        }
                                    }
                                }, 2000);
                            }
                        }, 1000);
                    }, 100);
                    
                } catch (err) {
                    console.error('提交處理出錯:', err);
                    alert('發生錯誤，請重試: ' + err.message);
                    
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                    
                    // 顯示手動跳轉按鈕
                    const manualRedirect = document.getElementById('manual-redirect');
                    if (manualRedirect) {
                        manualRedirect.style.display = 'block';
                    }
                }
            });
        }
        
        // 綁定手動跳轉按鈕
        const manualRedirectBtn = document.getElementById('manual-redirect-btn');
        if (manualRedirectBtn) {
            manualRedirectBtn.addEventListener('click', function() {
                console.log('點擊了手動跳轉按鈕');
                
                // 先確保所有數據都儲存到sessionStorage
                sessionStorage.setItem('userHealthNeed', window.userSelections.healthNeed || '改善睡眠品質');
                sessionStorage.setItem('userLifestyle', window.userSelections.lifestyle || '長時間工作');
                sessionStorage.setItem('userBudget', window.userSelections.budget || 0);
                
                // 確保有測試數據
                if (!sessionStorage.getItem('recommendedProducts')) {
                    const testProducts = [
                        {
                            id: "manual1",
                            name: "手動跳轉-測試產品",
                            brand: "測試品牌",
                            description: "這是通過手動跳轉按鈕創建的測試產品數據。",
                            price: 350,
                            rating: 4.5,
                            image_url: "https://via.placeholder.com/150",
                            benefits: ["測試功效1", "測試功效2"],
                            usage: "測試用法說明",
                            caution: "測試注意事項",
                            ingredients: "測試成分",
                            health_needs: ["改善睡眠品質"],
                            lifestyle_match: ["長時間工作"]
                        }
                    ];
                    sessionStorage.setItem('recommendedProducts', JSON.stringify(testProducts));
                }
                
                // 直接使用location.replace進行跳轉，這樣不會添加到歷史記錄中
                try {
                    console.log('手動跳轉 - 嘗試使用location.replace');
                    window.location.replace('results.html');
                } catch (err) {
                    console.error('手動跳轉 - location.replace失敗:', err);
                    
                    // 如果replace失敗，嘗試使用href
                    try {
                        console.log('手動跳轉 - 嘗試使用location.href');
                        window.location.href = 'results.html';
                    } catch (err2) {
                        console.error('手動跳轉 - location.href也失敗:', err2);
                        alert('跳轉失敗，請嘗試直接在瀏覽器地址欄輸入 /results.html');
                    }
                }
            });
        }
    });

    // 在開發模式下顯示調試工具
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        document.getElementById('debug-tools').style.display = 'block';
        
        // 顯示sessionStorage數據
        document.getElementById('debug-show-data').addEventListener('click', function() {
            const output = document.getElementById('debug-output');
            output.style.display = 'block';
            let data = '';
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                let value = sessionStorage.getItem(key);
                
                // 如果是JSON，嘗試格式化顯示
                try {
                    const parsedValue = JSON.parse(value);
                    if (typeof parsedValue === 'object') {
                        value = '(Object with ' + Object.keys(parsedValue).length + ' properties)';
                    }
                } catch (e) {
                    // 不是JSON，保持原樣
                }
                
                data += `${key}: ${value}\n`;
            }
            
            // 顯示window.userSelections
            data += '\nwindow.userSelections:\n';
            data += JSON.stringify(window.userSelections, null, 2);
            
            output.textContent = data;
        });
        
        // 測試頁面跳轉
        document.getElementById('debug-test-redirect').addEventListener('click', function() {
            const output = document.getElementById('debug-output');
            output.style.display = 'block';
            output.textContent = '嘗試跳轉到results.html...\n';
            
            // 依次嘗試不同的跳轉方式
            const methods = [
                '1. location.href',
                '2. location.replace',
                '3. 創建連結並點擊',
                '4. 創建表單並提交',
                '5. window.open'
            ];
            
            let currentMethod = 0;
            
            function tryNextMethod() {
                if (currentMethod >= methods.length) {
                    output.textContent += '\n所有跳轉方式都已嘗試完畢。請檢查網頁和控制台。';
                    return;
                }
                
                output.textContent += `\n嘗試方法: ${methods[currentMethod]}\n`;
                
                switch (currentMethod) {
                    case 0:
                        try {
                            window.location.href = 'results.html';
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            currentMethod++;
                            setTimeout(tryNextMethod, 1000);
                        }
                        break;
                        
                    case 1:
                        try {
                            window.location.replace('results.html');
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            currentMethod++;
                            setTimeout(tryNextMethod, 1000);
                        }
                        break;
                        
                    case 2:
                        try {
                            const link = document.createElement('a');
                            link.href = 'results.html';
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            currentMethod++;
                            setTimeout(tryNextMethod, 1000);
                        }
                        break;
                        
                    case 3:
                        try {
                            const form = document.createElement('form');
                            form.action = 'results.html';
                            form.method = 'get';
                            document.body.appendChild(form);
                            form.submit();
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            currentMethod++;
                            setTimeout(tryNextMethod, 1000);
                        }
                        break;
                        
                    case 4:
                        try {
                            window.open('results.html', '_self');
                            output.textContent += '執行完畢，檢查是否跳轉成功...';
                        } catch (e) {
                            output.textContent += `錯誤: ${e.message}`;
                            output.textContent += '\n所有方法都嘗試失敗。';
                        }
                        break;
                }
                
                currentMethod++;
            }
            
            tryNextMethod();
        });
        
        // 清除所有數據
        document.getElementById('debug-clear-data').addEventListener('click', function() {
            sessionStorage.clear();
            window.userSelections = {
                healthNeed: '',
                lifestyle: '',
                budget: 0
            };
            
            const output = document.getElementById('debug-output');
            output.style.display = 'block';
            output.textContent = '所有數據已清除';
        });
    }
    </script>

    <!-- 添加對話框漸入動畫的JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 選取所有 chat-message 元素
            const chatMessages = document.querySelectorAll('.chat-message');
            
            // 使用 setTimeout 添加延遲，使動畫效果更明顯
            chatMessages.forEach((message, index) => {
                setTimeout(() => {
                    message.style.opacity = '1';
                }, 100 * (index + 1)); // 每個對話框依序顯示
            });
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>營養好朋友 - 保健品資訊</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- iOS 狀態欄 -->
    <div class="status-bar">
        <div class="status-bar-time">9:45</div>
        <div class="status-bar-icons">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-full"></i>
        </div>
    </div>

    <!-- 頂部導航 -->
    <div style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-color); background-color: white;">
        <a href="chat.html" style="color: var(--text-primary); margin-right: 12px;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div style="flex: 1; text-align: center; font-weight: 600;">熱門保健品資訊</div>
        <a href="#" style="color: var(--primary);">
            <i class="fas fa-share-alt"></i>
        </a>
    </div>

    <!-- 主要內容區 -->
    <div class="app-content" style="padding: 16px;">
        <!-- 結果摘要 -->
        <div class="card" style="margin-bottom: 24px;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <div class="avatar" style="background-color: var(--primary);">
                    <i class="fas fa-archive"></i>
                </div>
                <div>
                    <p style="margin: 0 0 2px; font-weight: 600;">小帕 Pal 的資料整理</p>
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">根據熱門選擇整理</p>
                </div>
            </div>
            <p class="selection-summary" style="margin: 0 0 12px;">根據你選擇的「<span class="health-need-display" style="color: var(--primary); font-weight: 600;">改善睡眠品質</span>」需求，以及「<span class="lifestyle-display" style="color: var(--primary); font-weight: 600;">長時間工作</span>」的生活型態，以下是我整理的熱門保健品資訊。</p>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <span class="badge">相關熱門選擇</span>
                <span class="badge result-category">睡眠相關</span>
                <span class="badge">壓力緩解</span>
            </div>
        </div>

        <!-- 推薦產品列表 -->
        <h2 style="font-size: 18px; margin-bottom: 16px;">基礎熱門組合</h2>
        
        <!-- 產品容器 -->
        <div class="product-list" id="recommended-products">
            <!-- 產品將由JavaScript動態生成 -->
            <div class="loading-spinner" style="margin: 20px auto;"></div>
        </div>

        <!-- 進階推薦 -->
        <h2 style="font-size: 18px; margin: 24px 0 16px;">延伸相關選擇</h2>
        
        <!-- 相關產品容器 -->
        <div class="product-list" id="related-products">
            <!-- 相關產品將由JavaScript動態生成 -->
        </div>

        <!-- 每日服用時間表 -->
        <div class="card" style="margin-top: 24px;">
            <h2 style="font-size: 18px; margin: 0 0 16px;">常見使用時間參考</h2>
            
            <div class="timeline" id="usage-timeline">
                <!-- 時間表將由JavaScript動態生成 -->
            </div>
        </div>

        <!-- 注意事項 -->
        <div class="card" style="margin-top: 16px;" id="product-cautions">
            <h3 style="font-size: 16px; margin: 0 0 12px;">常見注意事項參考</h3>
            <ul class="cautions-list" style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--text-secondary);">
                <!-- 注意事項將由JavaScript動態生成 -->
            </ul>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 12px; text-align: center;">小帕不提供任何醫療建議，所有資訊僅供參考，請諮詢專業醫師進行健康決策～</p>
        </div>

        <!-- 操作按鈕 -->
        <div style="display: flex; gap: 12px; margin-top: 24px; margin-bottom: 100px;">
            <button class="btn-secondary" style="flex: 1;">
                <i class="fas fa-download"></i> 下載資訊
            </button>
            <button class="btn-primary" style="flex: 1;">
                <i class="fas fa-envelope"></i> 發送至 Email
            </button>
        </div>
    </div>

    <!-- 底部導航欄 -->
    <div class="tab-bar">
        <a href="home.html" class="tab-item">
            <i class="fas fa-home"></i>
            <span>首頁</span>
        </a>
        <a href="chat.html" class="tab-item">
            <i class="fas fa-comment-medical"></i>
            <span>諮詢</span>
        </a>
        <a href="knowledge.html" class="tab-item">
            <i class="fas fa-book-medical"></i>
            <span>知識庫</span>
        </a>
        <a href="#" class="tab-item">
            <i class="fas fa-user"></i>
            <span>我的</span>
        </a>
    </div>

    <!-- 引入腳本 -->
    <script src="js/recommendationEngine.js"></script>
    <!-- 不載入 main.js 以避免語法錯誤問題 -->
    <!-- <script src="js/main.js"></script> -->

    <!-- 添加備用顯示代碼 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('results.html 頁面加載完成');
            
            // 檢查URL參數
            const urlParams = new URLSearchParams(window.location.search);
            const healthParam = urlParams.get('health');
            const lifestyleParam = urlParams.get('lifestyle');
            const budgetParam = urlParams.get('budget');
            
            console.log('URL參數:', {health: healthParam, lifestyle: lifestyleParam, budget: budgetParam});
            
            // 如果URL有參數但sessionStorage沒有數據，則使用URL參數
            if (healthParam && !sessionStorage.getItem('userHealthNeed')) {
                sessionStorage.setItem('userHealthNeed', healthParam);
                console.log('從URL參數加載健康需求:', healthParam);
            }
            
            if (lifestyleParam && !sessionStorage.getItem('userLifestyle')) {
                sessionStorage.setItem('userLifestyle', lifestyleParam);
                console.log('從URL參數加載生活型態:', lifestyleParam);
            }
            
            if (budgetParam && !sessionStorage.getItem('userBudget')) {
                sessionStorage.setItem('userBudget', budgetParam);
                console.log('從URL參數加載預算:', budgetParam);
            }
            
            // 檢查sessionStorage中的數據
            const storedHealthNeed = sessionStorage.getItem('userHealthNeed');
            const storedLifestyle = sessionStorage.getItem('userLifestyle');
            const storedBudget = sessionStorage.getItem('userBudget');
            
            console.log('SessionStorage數據:', {
                userHealthNeed: storedHealthNeed,
                userLifestyle: storedLifestyle,
                userBudget: storedBudget
            });
            
            // 直接更新頁面上的顯示
            updateResultsDisplay();
            
            // 如果沒有產品數據，創建備用數據
            if (!sessionStorage.getItem('recommendedProducts')) {
                console.log('沒有找到產品數據，創建備用數據');
                
                const defaultProducts = [
                    {
                        id: "default1",
                        name: "褪黑激素3mg",
                        brand: "睡眠專家",
                        description: "促進自然睡眠的褪黑激素補充劑，改善入睡時間和睡眠品質。",
                        price: 350,
                        rating: 4.6,
                        image_url: "https://via.placeholder.com/150",
                        benefits: ["改善睡眠質量", "縮短入睡時間", "調節生理時鐘"],
                        usage: "睡前30分鐘服用1粒",
                        caution: "白天避免服用，可能導致嗜睡",
                        ingredients: "褪黑激素、植物性膠囊",
                        health_needs: ["改善睡眠品質"],
                        lifestyle_match: ["經常熬夜", "長時間工作"]
                    },
                    {
                        id: "default2",
                        name: "複合鎂補充劑",
                        brand: "營養均衡",
                        description: "含多種形式鎂的複合配方，幫助放鬆肌肉，改善睡眠，緩解壓力。",
                        price: 420,
                        rating: 4.5,
                        image_url: "https://via.placeholder.com/150",
                        benefits: ["肌肉放鬆", "改善睡眠", "減輕壓力"],
                        usage: "每日1-2粒，晚餐時服用",
                        caution: "某些形式的鎂可能有輕微腹瀉作用",
                        ingredients: "甘氨酸鎂、檸檬酸鎂、氧化鎂",
                        health_needs: ["改善睡眠品質", "骨骼與關節健康"],
                        lifestyle_match: ["長時間工作", "經常熬夜"]
                    }
                ];
                
                sessionStorage.setItem('recommendedProducts', JSON.stringify(defaultProducts));
            }
            
            // 立即顯示產品
            displayFallbackProducts(); 
            
            // 顯示相關產品
            displayRelatedProducts();
        });
        
        // 更新結果頁面顯示
        function updateResultsDisplay() {
            const healthNeedDisplay = document.querySelector('.health-need-display');
            const lifestyleDisplay = document.querySelector('.lifestyle-display');
            
            if (healthNeedDisplay) {
                const healthNeed = sessionStorage.getItem('userHealthNeed') || '改善睡眠品質';
                healthNeedDisplay.textContent = healthNeed;
            }
            
            if (lifestyleDisplay) {
                const lifestyle = sessionStorage.getItem('userLifestyle') || '長時間工作';
                lifestyleDisplay.textContent = lifestyle;
            }
            
            // 更新結果類別
            const resultCategory = document.querySelector('.result-category');
            if (resultCategory) {
                const healthNeed = sessionStorage.getItem('userHealthNeed') || '改善睡眠品質';
                let categoryText = '一般保健';
                
                // 根據健康需求設置類別
                if (healthNeed.includes('睡眠')) {
                    categoryText = '睡眠相關';
                } else if (healthNeed.includes('免疫')) {
                    categoryText = '免疫相關';
                } else if (healthNeed.includes('腦力')) {
                    categoryText = '認知相關';
                } else if (healthNeed.includes('心臟')) {
                    categoryText = '心臟相關';
                } else if (healthNeed.includes('骨骼')) {
                    categoryText = '關節相關';
                } else if (healthNeed.includes('視力')) {
                    categoryText = '視力相關';
                } else if (healthNeed.includes('肝臟')) {
                    categoryText = '肝臟相關';
                } else if (healthNeed.includes('女性')) {
                    categoryText = '女性相關';
                } else if (healthNeed.includes('消化')) {
                    categoryText = '消化相關';
                } else if (healthNeed.includes('體重')) {
                    categoryText = '體重相關';
                }
                
                resultCategory.textContent = categoryText;
            }
        }
        
        // 顯示備用產品
        function displayFallbackProducts() {
            const productsContainer = document.getElementById('recommended-products');
            if (!productsContainer) return;
            
            // 清除載入動畫
            productsContainer.innerHTML = '';
            
            try {
                // 從 sessionStorage 獲取產品數據
                const productsData = JSON.parse(sessionStorage.getItem('recommendedProducts') || '[]');
                
                if (productsData.length === 0) {
                    productsContainer.innerHTML = '<p class="text-center" style="padding: 20px;">沒有找到符合條件的產品。</p>';
                    return;
                }
                
                // 遍歷產品數據並創建產品卡片
                productsData.forEach(product => {
                    const productCard = createProductCard(product);
                    productsContainer.appendChild(productCard);
                });
            } catch (error) {
                console.error('顯示產品時出錯:', error);
                productsContainer.innerHTML = '<p class="text-center" style="padding: 20px;">加載產品數據時出錯。</p>';
            }
        }
        
        // 創建產品卡片元素
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            // 計算評分星星
            const fullStars = Math.floor(product.rating);
            const hasHalfStar = product.rating % 1 >= 0.5;
            let starsHtml = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHtml += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && hasHalfStar) {
                    starsHtml += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHtml += '<i class="far fa-star"></i>';
                }
            }
            
            // 設置卡片內容
            card.innerHTML = `
                <div class="product-image" style="background-image: url('${product.image_url}');"></div>
                <div class="product-details">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3 style="margin: 0 0 4px; font-size: 16px;">${product.name}</h3>
                            <p style="margin: 0 0 4px; font-size: 12px; color: var(--text-secondary);">${product.brand}</p>
                        </div>
                        <div style="color: var(--primary); font-weight: 600; font-size: 16px;">$${product.price}</div>
                    </div>
                    <div style="display: flex; align-items: center; margin: 6px 0; font-size: 12px; color: var(--warning);">
                        ${starsHtml}
                        <span style="margin-left: 4px; color: var(--text-secondary);">${product.rating}</span>
                    </div>
                    <p style="margin: 0 0 8px; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">${product.description}</p>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        ${product.benefits.map(benefit => `<span class="badge">${benefit}</span>`).join('')}
                    </div>
                    <button class="btn-outline" style="width: 100%; margin-top: 12px;">
                        <i class="fas fa-external-link-alt"></i> 查看 iHerb
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // 顯示相關產品
        function displayRelatedProducts() {
            const relatedContainer = document.getElementById('related-products');
            if (!relatedContainer) return;
            
            try {
                // 創建兩個相關產品
                const relatedProducts = [
                    {
                        id: "related1",
                        name: "魚油 1000mg",
                        brand: "健康海洋",
                        description: "高純度魚油，富含EPA和DHA，支持心臟和大腦健康。",
                        price: 450,
                        rating: 4.7,
                        image_url: "https://via.placeholder.com/150",
                        benefits: ["心臟健康", "腦部健康", "抗發炎"],
                        usage: "每日1-2粒，餐後服用",
                        caution: "可能有輕微魚腥味",
                        ingredients: "魚油、明膠膠囊、天然維生素E",
                        health_needs: ["心臟健康", "提升腦力與專注"],
                        lifestyle_match: ["長時間工作", "壓力大"]
                    },
                    {
                        id: "related2",
                        name: "維生素B群+葉酸",
                        brand: "營養科學",
                        description: "完整的B族維生素組合，支持能量產生和神經系統健康。",
                        price: 380,
                        rating: 4.6,
                        image_url: "https://via.placeholder.com/150",
                        benefits: ["提升能量", "降低壓力", "支持神經系統"],
                        usage: "每日1粒，餐後服用",
                        caution: "可能使尿液變黃，屬正常現象",
                        ingredients: "全套B族維生素、葉酸、生物素",
                        health_needs: ["提升腦力與專注", "增強免疫力"],
                        lifestyle_match: ["壓力大", "長時間工作"]
                    }
                ];
                
                // 遍歷相關產品數據並創建產品卡片
                relatedProducts.forEach(product => {
                    const productCard = createProductCard(product);
                    relatedContainer.appendChild(productCard);
                });
                
                // 創建並顯示使用時間表
                createUsageTimeline();
                
                // 創建並顯示注意事項
                createCautions();
                
            } catch (error) {
                console.error('顯示相關產品時出錯:', error);
                relatedContainer.innerHTML = '<p class="text-center" style="padding: 20px;">加載相關產品時出錯。</p>';
            }
        }
        
        // 創建使用時間表
        function createUsageTimeline() {
            const timelineContainer = document.getElementById('usage-timeline');
            if (!timelineContainer) return;
            
            const timepoints = [
                { time: '早晨空腹', products: ['維生素D3', '綜合維他命'] },
                { time: '早餐時', products: ['維生素B群', '魚油'] },
                { time: '午餐時', products: ['鈣片', '消化酵素'] },
                { time: '晚餐時', products: ['鎂補充劑', '益生菌'] },
                { time: '睡前30分鐘', products: ['褪黑激素', '纈草根萃取物'] }
            ];
            
            timelineContainer.innerHTML = '';
            
            timepoints.forEach(point => {
                const timeItem = document.createElement('div');
                timeItem.className = 'timeline-item';
                timeItem.innerHTML = `
                    <div class="timeline-time">${point.time}</div>
                    <div class="timeline-content">
                        ${point.products.map(product => `<span class="badge">${product}</span>`).join('')}
                    </div>
                `;
                timelineContainer.appendChild(timeItem);
            });
        }
        
        // 創建注意事項
        function createCautions() {
            const cautionsContainer = document.getElementById('product-cautions');
            if (!cautionsContainer) return;
            
            const cautionsList = cautionsContainer.querySelector('.cautions-list');
            if (!cautionsList) return;
            
            const cautions = [
                '保健品不能替代均衡飲食，應搭配健康的生活方式使用',
                '如正在服用藥物或有特殊健康狀況，請在使用前諮詢醫師',
                '孕婦和哺乳期婦女應特別注意保健品成分是否適合',
                '兒童不宜使用成人劑量，應使用專為兒童設計的產品',
                '請務必遵循產品標示的使用劑量，不建議過量使用'
            ];
            
            cautionsList.innerHTML = '';
            
            cautions.forEach(caution => {
                const item = document.createElement('li');
                item.innerHTML = caution;
                cautionsList.appendChild(item);
            });
        }
    </script>
    
    <!-- 調試按鈕 (只在開發模式顯示) -->
    <div id="debug-tools" style="display: none; position: fixed; bottom: 70px; right: 10px; z-index: 1000;">
        <button id="debug-button" style="background: rgba(0,0,0,0.7); color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px;">
            顯示調試信息
        </button>
        <div id="debug-panel" style="display: none; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 4px; margin-top: 5px; max-height: 300px; overflow: auto; width: 300px; font-size: 12px;">
        </div>
    </div>
    
    <script>
        // 添加調試按鈕功能
        document.addEventListener('DOMContentLoaded', function() {
            // 只在開發環境顯示調試工具
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('debug-tools').style.display = 'block';
                
                document.getElementById('debug-button').addEventListener('click', function() {
                    const panel = document.getElementById('debug-panel');
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    
                    if (panel.style.display === 'block') {
                        // 顯示調試信息
                        let debugInfo = '<h4>SessionStorage數據:</h4>';
                        
                        for (let i = 0; i < sessionStorage.length; i++) {
                            const key = sessionStorage.key(i);
                            let value = sessionStorage.getItem(key);
                            
                            // 如果是JSON，嘗試格式化顯示
                            try {
                                const parsedValue = JSON.parse(value);
                                if (typeof parsedValue === 'object') {
                                    value = `(Object with ${Object.keys(parsedValue).length} properties)`;
                                }
                            } catch (e) {
                                // 不是JSON，保持原樣
                            }
                            
                            debugInfo += `<div><strong>${key}:</strong> ${value}</div>`;
                        }
                        
                        // 添加頁面跳轉工具
                        debugInfo += '<h4>頁面操作:</h4>';
                        debugInfo += '<button id="debug-go-home" style="margin: 5px; padding: 5px;">返回首頁</button>';
                        debugInfo += '<button id="debug-go-chat" style="margin: 5px; padding: 5px;">返回諮詢頁</button>';
                        debugInfo += '<button id="debug-reload" style="margin: 5px; padding: 5px;">重新載入</button>';
                        debugInfo += '<button id="debug-clear-storage" style="margin: 5px; padding: 5px;">清除數據</button>';
                        
                        panel.innerHTML = debugInfo;
                        
                        // 綁定按鈕事件
                        document.getElementById('debug-go-home').addEventListener('click', function() {
                            window.location.href = 'index.html';
                        });
                        
                        document.getElementById('debug-go-chat').addEventListener('click', function() {
                            window.location.href = 'chat.html';
                        });
                        
                        document.getElementById('debug-reload').addEventListener('click', function() {
                            window.location.reload();
                        });
                        
                        document.getElementById('debug-clear-storage').addEventListener('click', function() {
                            sessionStorage.clear();
                            alert('已清除所有sessionStorage數據');
                            window.location.reload();
                        });
                    }
                });
            }
        });
    </script>
</body>
</html> 
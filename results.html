<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>營養好朋友 - 保健品資訊</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- 頂部導航 -->
    <div class="nav-header">
        <a href="chat.html" style="color: var(--text-primary); margin-right: 12px;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div style="flex: 1; text-align: center; font-weight: 600;">保健品推薦</div>
        <a href="#" onclick="shareResults()" style="margin-left: 12px; color: var(--text-primary);">
            <i class="fas fa-share-alt"></i>
        </a>
    </div>

    <!-- 主要內容區 -->
    <div class="app-content" style="padding: 16px;">
        <!-- 結果摘要 -->
        <div class="card" style="margin-bottom: 24px;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <div class="avatar" style="background-color: var(--primary);">
                    <i class="fas fa-archive"></i>
                </div>
                <div>
                    <p style="margin: 0 0 2px; font-weight: 600;">小帕 Pal 的資料整理</p>
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">根據熱門選擇整理</p>
                </div>
            </div>
            <p class="selection-summary" style="margin: 0 0 12px;">根據你選擇的「<span class="health-need-display" style="color: var(--primary); font-weight: 600;">改善睡眠品質</span>」需求，以及「<span class="lifestyle-display" style="color: var(--primary); font-weight: 600;">長時間工作</span>」的生活型態，以下是我整理的熱門保健品資訊。</p>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <span class="badge">相關熱門選擇</span>
                <span class="badge result-category">睡眠相關</span>
                <span class="badge">壓力緩解</span>
            </div>
        </div>

        <!-- 推薦產品列表 -->
        <h2 style="font-size: 18px; margin-bottom: 16px;">基礎熱門組合</h2>
        
        <!-- 產品容器 -->
        <div class="product-list" id="recommended-products">
            <!-- 產品將由JavaScript動態生成 -->
            <div class="loading-spinner" style="margin: 20px auto;"></div>
        </div>

        <!-- 進階推薦 -->
        <h2 style="font-size: 18px; margin: 24px 0 16px;">延伸相關選擇</h2>
        
        <!-- 相關產品容器 -->
        <div class="product-list" id="related-products">
            <!-- 相關產品將由JavaScript動態生成 -->
        </div>

        <!-- 每日服用時間表 -->
        <div class="card" style="margin-top: 24px;">
            <h2 style="font-size: 18px; margin: 0 0 16px;">常見使用時間參考</h2>
            
            <div class="timeline" id="usage-timeline">
                <!-- 時間表將由JavaScript動態生成 -->
            </div>
        </div>

        <!-- 注意事項 -->
        <div class="card" style="margin-top: 16px;" id="product-cautions">
            <h3 style="font-size: 16px; margin: 0 0 12px;">常見注意事項參考</h3>
            <ul class="cautions-list" style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--text-secondary);">
                <!-- 注意事項將由JavaScript動態生成 -->
            </ul>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 12px; text-align: center;">小帕不提供任何醫療建議，所有資訊僅供參考，請諮詢專業醫師進行健康決策～</p>
        </div>

        <!-- 操作按鈕 -->
        <div style="display: flex; gap: 12px; margin-top: 24px; margin-bottom: 100px;">
            <button class="btn-secondary" style="flex: 1;">
                <i class="fas fa-download"></i> 下載資訊
            </button>
            <button class="btn-primary" style="flex: 1;">
                <i class="fas fa-envelope"></i> 發送至 Email
            </button>
        </div>
    </div>

    <!-- 底部導航欄 -->
    <div class="tab-bar">
        <a href="home.html" class="tab-item">
            <i class="fas fa-home"></i>
            <span>首頁</span>
        </a>
        <a href="chat.html" class="tab-item">
            <i class="fas fa-comment-medical"></i>
            <span>諮詢</span>
        </a>
        <a href="knowledge.html" class="tab-item">
            <i class="fas fa-book-medical"></i>
            <span>知識庫</span>
        </a>
        <a href="#" class="tab-item">
            <i class="fas fa-user"></i>
            <span>我的</span>
        </a>
    </div>

    <!-- 引入腳本 -->
    <script type="module" src="js/recommendationEngine.js"></script>
    <!-- 不載入 main.js 以避免語法錯誤問題 -->
    <!-- <script src="js/main.js"></script> -->

    <!-- 修改備用顯示代碼為模塊，並始終獲取新推薦 -->
    <script type="module">
        // 導入將要實現的推薦引擎初始化函數
        import { initializeRecommendations } from './js/recommendationEngine.js'; 
        // 導入顯示產品、時間線、注意事項的函數 (假設它們也被導出或移到 recommendationEngine)
        // 或者讓 initializeRecommendations 處理 DOM 更新

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('results.html 頁面加載完成 - 使用模塊加載邏輯');
            
            // 1. 獲取用戶輸入 (保留現有邏輯)
            const urlParams = new URLSearchParams(window.location.search);
            const healthParam = urlParams.get('health');
            const lifestyleParam = urlParams.get('lifestyle');
            const budgetParam = urlParams.get('budget');
            
            console.log('URL參數檢查:', { healthParam, lifestyleParam, budgetParam });
            
            let healthNeed = localStorage.getItem('userHealthNeed') || sessionStorage.getItem('userHealthNeed');
            let lifestyle = localStorage.getItem('userLifestyle') || sessionStorage.getItem('userLifestyle');
            let budget = localStorage.getItem('userBudget') || sessionStorage.getItem('userBudget');
            
            // 如果儲存中沒有，則使用URL參數
            if (!healthNeed && healthParam) healthNeed = healthParam;
            if (!lifestyle && lifestyleParam) lifestyle = lifestyleParam;
            if (!budget && budgetParam) budget = budgetParam;
             
            // 設置默認值，確保一定有數據可用
            if (!healthNeed) healthNeed = '改善睡眠品質';
            if (!lifestyle) lifestyle = '長時間工作';
            if (!budget) budget = '1000'; // 設置一個默認預算

            // 將獲取到的值存回 storage，以備不時之需或跨頁面使用
            localStorage.setItem('userHealthNeed', healthNeed);
            localStorage.setItem('userLifestyle', lifestyle);
            localStorage.setItem('userBudget', budget);
            sessionStorage.setItem('userHealthNeed', healthNeed);
            sessionStorage.setItem('userLifestyle', lifestyle);
            sessionStorage.setItem('userBudget', budget);

            console.log('最終用戶輸入:', { healthNeed, lifestyle, budget });

            // 2. 更新結果摘要顯示 (保留現有邏輯，因為它只更新文本)
            updateResultsDisplay(healthNeed, lifestyle, budget);
            
            // 3. 調用推薦引擎獲取並顯示產品 (新邏輯)
            try {
                // 顯示加載指示器
                const productContainer = document.getElementById('recommended-products');
                if (productContainer) {
                    productContainer.innerHTML = '<div class="loading-spinner" style="margin: 20px auto;"></div>';
                }
                
                // 調用推薦引擎的主函數 (假設它處理數據獲取、篩選和DOM更新)
                await initializeRecommendations(healthNeed, lifestyle, parseInt(budget));
                console.log('推薦產品已加載並顯示');

                // (可選) 更新相關產品、時間線、注意事項等，
                // 最好也由 initializeRecommendations 或其調用的函數處理
                // displayRelatedProducts(); // (如果需要，確保此函數也被處理)
                // updateTimeline(); // (如果需要，確保此函數也被處理)
                // updateCautions(); // (如果需要，確保此函數也被處理)

            } catch (error) {
                console.error('獲取或顯示推薦時出錯:', error);
                const productContainer = document.getElementById('recommended-products');
                if (productContainer) {
                    productContainer.innerHTML = '<p class="text-center">抱歉，載入推薦時發生錯誤，請稍後再試。</p>';
                }
            }
        });
        
        // 更新結果顯示的函數 (保留)
        function updateResultsDisplay(healthNeed, lifestyle, budget) {
            console.log('更新頁面顯示:', { healthNeed, lifestyle, budget });
            
            // 更新健康需求和生活型態顯示
            const healthDisplay = document.querySelector('.health-need-display');
            const lifestyleDisplay = document.querySelector('.lifestyle-display');
            
            if (healthDisplay) {
                healthDisplay.textContent = healthNeed || '改善睡眠品質';
            }
            
            if (lifestyleDisplay) {
                lifestyleDisplay.textContent = lifestyle || '長時間工作';
            }
            
            // 更新摘要文本
            const summaryElem = document.querySelector('.selection-summary');
            if (summaryElem) {
                const healthNeedText = healthNeed || '改善睡眠品質';
                const lifestyleText = lifestyle || '長時間工作';
                
                summaryElem.innerHTML = `根據你選擇的「<span class="health-need-display" style="color: var(--primary); font-weight: 600;">${healthNeedText}</span>」需求，以及「<span class="lifestyle-display" style="color: var(--primary); font-weight: 600;">${lifestyleText}</span>」的生活型態，以下是我整理的熱門保健品資訊。`;
            }
            
            // 更新分類標籤
            const categoryBadge = document.querySelector('.result-category');
            if (categoryBadge && healthNeed) {
                if (healthNeed === '改善睡眠品質') {
                    categoryBadge.textContent = '睡眠相關';
                } else if (healthNeed === '增強免疫力') {
                    categoryBadge.textContent = '免疫力相關';
                } else {
                    categoryBadge.textContent = healthNeed;
                }
            }
        }
    </script>
</body>
</html> 